import React, { useEffect, useState } from 'react'
import {
  Container,
  Typography,
  Card,
  CardContent,
  Box,
  Button,
  Chip,
  Grid,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  InputAdornment,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Pagination,
  Alert,
  CircularProgress,
  Tabs,
  Tab,
  Divider
} from '@mui/material'
import {
  Search as SearchIcon,
  FilterList as FilterIcon,
  Timeline as TimelineIcon,
  TableChart as TableIcon,
  BarChart as BarChartIcon,
  PieChart as PieChartIcon,
  Download as DownloadIcon,
  Refresh as RefreshIcon,
  ArrowBack as ArrowBackIcon
} from '@mui/icons-material'
import { useNavigate } from 'react-router-dom'
import { useDispatch, useSelector } from 'react-redux'
import type { AppDispatch, RootState } from '../store'
import { fetchHealthRecords } from '../store/slices/healthRecordsSlice'
import { useAuth } from '../hooks/useAuth'
import UnifiedNavigation from '../components/UnifiedNavigation'
import BloodPressureChart from '../components/charts/BloodPressureChart'
import BloodSugarChart from '../components/charts/BloodSugarChart'
import WeightChart from '../components/charts/WeightChart'

interface TabPanelProps {
  children?: React.ReactNode
  index: number
  value: number
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`simple-tabpanel-${index}`}
      aria-labelledby={`simple-tab-${index}`}
      {...other}
    >
      {value === index && (
        <Box sx={{ p: 3 }}>
          {children}
        </Box>
      )}
    </div>
  )
}

const AllDataViewPage: React.FC = () => {
  const navigate = useNavigate()
  const dispatch = useDispatch<AppDispatch>()
  const { user } = useAuth()
  const { records, loading, error } = useSelector((state: RootState) => state.healthRecords)
  
  // ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [tabValue, setTabValue] = useState(0)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterType, setFilterType] = useState('all')
  const [sortBy, setSortBy] = useState('date')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')
  const [page, setPage] = useState(1)
  const [viewMode, setViewMode] = useState<'timeline' | 'table' | 'charts'>('timeline')

  const recordsPerPage = 20

  // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    if (user?.id) {
      dispatch(fetchHealthRecords(user.id))
    }
  }, [dispatch, user?.id])

  // ÌïÑÌÑ∞ÎßÅ Î∞è Ï†ïÎ†¨Îêú Îç∞Ïù¥ÌÑ∞
  const filteredRecords = React.useMemo(() => {
    let filtered = records

    // ÌÉÄÏûÖ ÌïÑÌÑ∞ÎßÅ
    if (filterType !== 'all') {
      filtered = filtered.filter(record => record.record_type === filterType)
    }

    // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞ÎßÅ
    if (searchTerm) {
      filtered = filtered.filter(record => 
        record.notes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        record.record_type.toLowerCase().includes(searchTerm.toLowerCase())
      )
    }

    // Ï†ïÎ†¨ (Î∞∞Ïó¥ÏùÑ Î≥µÏÇ¨Ìïú ÌõÑ Ï†ïÎ†¨)
    return [...filtered].sort((a, b) => {
      let aValue, bValue
      
      switch (sortBy) {
        case 'date':
          aValue = new Date(a.measurement_time).getTime()
          bValue = new Date(b.measurement_time).getTime()
          break
        case 'type':
          aValue = a.record_type
          bValue = b.record_type
          break
        default:
          aValue = new Date(a.measurement_time).getTime()
          bValue = new Date(b.measurement_time).getTime()
      }

      if (sortOrder === 'asc') {
        return aValue > bValue ? 1 : -1
      } else {
        return aValue < bValue ? 1 : -1
      }
    })
  }, [records, filterType, searchTerm, sortBy, sortOrder])

  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
  const totalPages = Math.ceil(filteredRecords.length / recordsPerPage)
  const paginatedRecords = filteredRecords.slice(
    (page - 1) * recordsPerPage,
    page * recordsPerPage
  )

  // Ìó¨Ìçº Ìï®ÏàòÎì§
  const getRecordTypeLabel = (type: string) => {
    const labels: { [key: string]: string } = {
      blood_pressure: 'ÌòàÏïï',
      blood_sugar: 'ÌòàÎãπ',
      weight: 'Ï≤¥Ï§ë',
      heart_rate: 'Îß•Î∞ï',
      temperature: 'Ï≤¥Ïò®'
    }
    return labels[type] || type
  }

  const getRecordTypeColor = (type: string) => {
    const colors: { [key: string]: string } = {
      blood_pressure: '#ff6b6b',
      blood_sugar: '#4ecdc4',
      weight: '#45b7d1',
      heart_rate: '#ffa726',
      temperature: '#ab47bc'
    }
    return colors[type] || '#666'
  }

  const formatRecordValue = (record: any) => {
    switch (record.record_type) {
      case 'blood_pressure':
        return `${record.systolic_pressure || '-'}/${record.diastolic_pressure || '-'} mmHg`
      case 'blood_sugar':
        return `${record.blood_sugar || '-'} mg/dL (${record.blood_sugar_type === 'fasting' ? 'Í≥µÎ≥µ' : 'ÏãùÌõÑ'})`
      case 'weight':
        return `${record.weight || '-'} kg`
      case 'heart_rate':
        return `${record.heart_rate || '-'} bpm`
      case 'temperature':
        return `${record.temperature || '-'}¬∞C`
      default:
        return '-'
    }
  }

  const formatDateTime = (dateString: string) => {
    return new Date(dateString).toLocaleString('ko-KR', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue)
  }

  const handleRefresh = () => {
    if (user?.id) {
      dispatch(fetchHealthRecords(user.id))
    }
  }

  // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
  const stats = React.useMemo(() => {
    const bloodPressureRecords = records.filter(r => r.record_type === 'blood_pressure')
    const bloodSugarRecords = records.filter(r => r.record_type === 'blood_sugar')
    const weightRecords = records.filter(r => r.record_type === 'weight')
    
    return {
      total: records.length,
      bloodPressure: bloodPressureRecords.length,
      bloodSugar: bloodSugarRecords.length,
      weight: weightRecords.length,
      other: records.length - bloodPressureRecords.length - bloodSugarRecords.length - weightRecords.length
    }
  }, [records])

  return (
    <Box sx={{ flexGrow: 1 }}>
      {/* ÌÜµÌï© ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <UnifiedNavigation
        onGoalSetting={() => {/* TODO: Î™©Ìëú ÏÑ§Ï†ï Íµ¨ÌòÑ */}}
        onNotificationCenter={() => {/* TODO: ÏïåÎ¶º ÏÑºÌÑ∞ Íµ¨ÌòÑ */}}
        onNotificationSettings={() => {/* TODO: ÏïåÎ¶º ÏÑ§Ï†ï Íµ¨ÌòÑ */}}
        onCsvImport={() => {/* TODO: CSV Í∞ÄÏ†∏Ïò§Í∏∞ Íµ¨ÌòÑ */}}
        onHealthRecord={(type) => navigate(`/record?type=${type}`)}
        onBulkDelete={() => {/* TODO: Îã§Ï§ë ÏÇ≠Ï†ú Íµ¨ÌòÑ */}}
        onEditRecord={() => {/* TODO: Ìé∏Ïßë Íµ¨ÌòÑ */}}
      />

      <Container maxWidth="xl" sx={{ mt: 3, mb: 4 }}>
        {/* ÌéòÏù¥ÏßÄ Ï†úÎ™© */}
        <Typography variant="h4" sx={{ fontWeight: 700, mb: 3, color: 'text.primary' }}>
          üìä Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î∑∞
        </Typography>
        
        {/* ÌÜµÍ≥Ñ Ïπ¥Îìú */}
        <Grid container spacing={3} sx={{ mb: 4 }}>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ textAlign: 'center', backgroundColor: '#fff', border: '2px solid #667eea' }}>
              <CardContent>
                <Typography variant="h4" sx={{ color: '#667eea', fontWeight: 'bold' }}>
                  {stats.total}
                </Typography>
                <Typography variant="h6" sx={{ color: '#667eea', fontWeight: 600 }}>
                  Ï†ÑÏ≤¥ Í∏∞Î°ù
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ textAlign: 'center', backgroundColor: '#fff', border: '2px solid #ff6b6b' }}>
              <CardContent>
                <Typography variant="h4" sx={{ color: '#ff6b6b', fontWeight: 'bold' }}>
                  {stats.bloodPressure}
                </Typography>
                <Typography variant="h6" sx={{ color: '#ff6b6b', fontWeight: 600 }}>
                  ÌòàÏïï Í∏∞Î°ù
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ textAlign: 'center', backgroundColor: '#fff', border: '2px solid #4ecdc4' }}>
              <CardContent>
                <Typography variant="h4" sx={{ color: '#4ecdc4', fontWeight: 'bold' }}>
                  {stats.bloodSugar}
                </Typography>
                <Typography variant="h6" sx={{ color: '#4ecdc4', fontWeight: 600 }}>
                  ÌòàÎãπ Í∏∞Î°ù
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ textAlign: 'center', backgroundColor: '#fff', border: '2px solid #45b7d1' }}>
              <CardContent>
                <Typography variant="h4" sx={{ color: '#45b7d1', fontWeight: 'bold' }}>
                  {stats.weight}
                </Typography>
                <Typography variant="h6" sx={{ color: '#45b7d1', fontWeight: 600 }}>
                  Ï≤¥Ï§ë Í∏∞Î°ù
                </Typography>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        {/* Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ ÏÑπÏÖò */}
        <Card sx={{ mb: 3 }}>
          <CardContent>
            <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap', alignItems: 'center' }}>
              {/* Í≤ÄÏÉâ */}
              <TextField
                placeholder="Í∏∞Î°ù Í≤ÄÏÉâ..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <SearchIcon />
                    </InputAdornment>
                  ),
                }}
                sx={{ minWidth: 200 }}
              />

              {/* ÌÉÄÏûÖ ÌïÑÌÑ∞ */}
              <FormControl sx={{ minWidth: 120 }}>
                <InputLabel>Ï∏°Ï†ï Ïú†Ìòï</InputLabel>
                <Select
                  value={filterType}
                  onChange={(e) => setFilterType(e.target.value)}
                  label="Ï∏°Ï†ï Ïú†Ìòï"
                >
                  <MenuItem value="all">Ï†ÑÏ≤¥</MenuItem>
                  <MenuItem value="blood_pressure">ÌòàÏïï</MenuItem>
                  <MenuItem value="blood_sugar">ÌòàÎãπ</MenuItem>
                  <MenuItem value="weight">Ï≤¥Ï§ë</MenuItem>
                  <MenuItem value="heart_rate">Îß•Î∞ï</MenuItem>
                  <MenuItem value="temperature">Ï≤¥Ïò®</MenuItem>
                </Select>
              </FormControl>

              {/* Ï†ïÎ†¨ Í∏∞Ï§Ä */}
              <FormControl sx={{ minWidth: 120 }}>
                <InputLabel>Ï†ïÎ†¨ Í∏∞Ï§Ä</InputLabel>
                <Select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  label="Ï†ïÎ†¨ Í∏∞Ï§Ä"
                >
                  <MenuItem value="date">ÎÇ†Ïßú</MenuItem>
                  <MenuItem value="type">Ïú†Ìòï</MenuItem>
                </Select>
              </FormControl>

              {/* Ï†ïÎ†¨ ÏàúÏÑú */}
              <FormControl sx={{ minWidth: 100 }}>
                <InputLabel>ÏàúÏÑú</InputLabel>
                <Select
                  value={sortOrder}
                  onChange={(e) => setSortOrder(e.target.value as 'asc' | 'desc')}
                  label="ÏàúÏÑú"
                >
                  <MenuItem value="desc">ÏµúÏã†Ïàú</MenuItem>
                  <MenuItem value="asc">Ïò§ÎûòÎêúÏàú</MenuItem>
                </Select>
              </FormControl>

              {/* ÏÉà Í∏∞Î°ù Ï∂îÍ∞Ä */}
              <Button
                variant="contained"
                startIcon={<ArrowBackIcon />}
                onClick={() => navigate('/health-record')}
                sx={{ ml: 'auto' }}
              >
                ÏÉà Í∏∞Î°ù Ï∂îÍ∞Ä
              </Button>
            </Box>
          </CardContent>
        </Card>

        {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
        <Card>
          <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
            <Tabs value={tabValue} onChange={handleTabChange} aria-label="data view tabs">
              <Tab 
                icon={<TimelineIcon />} 
                label="ÌÉÄÏûÑÎùºÏù∏ Î∑∞" 
                iconPosition="start"
                sx={{ fontSize: '1rem', fontWeight: 600 }}
              />
              <Tab 
                icon={<TableIcon />} 
                label="ÌÖåÏù¥Î∏î Î∑∞" 
                iconPosition="start"
                sx={{ fontSize: '1rem', fontWeight: 600 }}
              />
              <Tab 
                icon={<BarChartIcon />} 
                label="Ï∞®Ìä∏ Î∑∞" 
                iconPosition="start"
                sx={{ fontSize: '1rem', fontWeight: 600 }}
              />
            </Tabs>
          </Box>

          {/* ÌÉÄÏûÑÎùºÏù∏ Î∑∞ */}
          <TabPanel value={tabValue} index={0}>
            {loading ? (
              <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                <CircularProgress size={60} />
              </Box>
            ) : error ? (
              <Alert severity="error" sx={{ mb: 3 }}>
                {error}
              </Alert>
            ) : paginatedRecords.length === 0 ? (
              <Box sx={{ textAlign: 'center', py: 6 }}>
                <Typography variant="h6" color="text.secondary" gutterBottom>
                  {filteredRecords.length === 0 ? 'Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.' : 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.'}
                </Typography>
                <Button
                  variant="contained"
                  onClick={() => navigate('/health-record')}
                  sx={{ mt: 2 }}
                >
                  Ï≤´ Í∏∞Î°ù Ï∂îÍ∞ÄÌïòÍ∏∞
                </Button>
              </Box>
            ) : (
              <Box>
                {paginatedRecords.map((record, index) => (
                  <Box key={record.id} sx={{ mb: 3 }}>
                    <Card sx={{ 
                      backgroundColor: '#fff',
                      border: `2px solid ${getRecordTypeColor(record.record_type)}`,
                      boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}>
                      <CardContent>
                        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                            <Chip
                              label={getRecordTypeLabel(record.record_type)}
                              sx={{
                                backgroundColor: getRecordTypeColor(record.record_type),
                                color: 'white',
                                fontWeight: 600,
                                fontSize: '1rem'
                              }}
                            />
                            <Typography variant="h6" sx={{ fontWeight: 600 }}>
                              {formatRecordValue(record)}
                            </Typography>
                          </Box>
                          <Typography variant="body2" color="text.secondary">
                            {formatDateTime(record.measurement_time)}
                          </Typography>
                        </Box>
                        {record.notes && (
                          <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                            üìù {record.notes}
                          </Typography>
                        )}
                      </CardContent>
                    </Card>
                  </Box>
                ))}
                
                {/* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */}
                {totalPages > 1 && (
                  <Box sx={{ display: 'flex', justifyContent: 'center', mt: 3 }}>
                    <Pagination
                      count={totalPages}
                      page={page}
                      onChange={(_, value) => setPage(value)}
                      color="primary"
                      size="large"
                    />
                  </Box>
                )}
              </Box>
            )}
          </TabPanel>

          {/* ÌÖåÏù¥Î∏î Î∑∞ */}
          <TabPanel value={tabValue} index={1}>
            {loading ? (
              <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                <CircularProgress size={60} />
              </Box>
            ) : error ? (
              <Alert severity="error" sx={{ mb: 3 }}>
                {error}
              </Alert>
            ) : paginatedRecords.length === 0 ? (
              <Box sx={{ textAlign: 'center', py: 6 }}>
                <Typography variant="h6" color="text.secondary" gutterBottom>
                  {filteredRecords.length === 0 ? 'Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.' : 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.'}
                </Typography>
                <Button
                  variant="contained"
                  onClick={() => navigate('/health-record')}
                  sx={{ mt: 2 }}
                >
                  Ï≤´ Í∏∞Î°ù Ï∂îÍ∞ÄÌïòÍ∏∞
                </Button>
              </Box>
            ) : (
              <TableContainer component={Paper}>
                <Table>
                  <TableHead>
                    <TableRow sx={{ backgroundColor: '#f5f5f5' }}>
                      <TableCell sx={{ fontWeight: 600, fontSize: '1.1rem' }}>Ï∏°Ï†ï Ïú†Ìòï</TableCell>
                      <TableCell sx={{ fontWeight: 600, fontSize: '1.1rem' }}>Ï∏°Ï†ïÍ∞í</TableCell>
                      <TableCell sx={{ fontWeight: 600, fontSize: '1.1rem' }}>Ï∏°Ï†ï ÏãúÍ∞Ñ</TableCell>
                      <TableCell sx={{ fontWeight: 600, fontSize: '1.1rem' }}>Î©îÎ™®</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {paginatedRecords.map((record) => (
                      <TableRow 
                        key={record.id}
                        hover
                        sx={{ 
                          '&:nth-of-type(odd)': { backgroundColor: '#fafafa' },
                          '&:hover': { backgroundColor: '#f0f0f0' }
                        }}
                      >
                        <TableCell>
                          <Chip
                            label={getRecordTypeLabel(record.record_type)}
                            sx={{
                              backgroundColor: getRecordTypeColor(record.record_type),
                              color: 'white',
                              fontWeight: 600
                            }}
                          />
                        </TableCell>
                        <TableCell>
                          <Typography variant="body1" sx={{ fontWeight: 500 }}>
                            {formatRecordValue(record)}
                          </Typography>
                        </TableCell>
                        <TableCell>
                          <Typography variant="body2" color="text.secondary">
                            {formatDateTime(record.measurement_time)}
                          </Typography>
                        </TableCell>
                        <TableCell>
                          <Typography variant="body2" color="text.secondary">
                            {record.notes || '-'}
                          </Typography>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            )}
          </TabPanel>

          {/* Ï∞®Ìä∏ Î∑∞ */}
          <TabPanel value={tabValue} index={2}>
            <Grid container spacing={3}>
              <Grid item xs={12}>
                <BloodPressureChart data={records} height={400} />
              </Grid>
              <Grid item xs={12}>
                <BloodSugarChart data={records} height={400} />
              </Grid>
              <Grid item xs={12}>
                <WeightChart data={records} height={400} />
              </Grid>
            </Grid>
          </TabPanel>
        </Card>
      </Container>
    </Box>
  )
}

export default AllDataViewPage
