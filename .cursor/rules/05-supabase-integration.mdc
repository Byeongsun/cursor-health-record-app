---
globs: src/lib/**/*.ts,src/store/slices/**/*.ts
description: Supabase Integration Guidelines
---

# ğŸ—„ï¸ Supabase Integration Guidelines

## âš™ï¸ Client Configuration

### Environment Variables
```typescript
// âœ… Always use environment variables with fallbacks
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || 'https://rkidyixevbnqkogcvhhy.supabase.co'
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || 'fallback_key'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### Type Definitions
```typescript
// âœ… Define comprehensive database types
export type Database = {
  public: {
    Tables: {
      users: {
        Row: {
          id: string
          email: string
          name: string
          birth_year: number | null
          gender: string | null
          phone: string | null
          emergency_contact: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          email: string
          name: string
          birth_year?: number | null
          gender?: string | null
          phone?: string | null
          emergency_contact?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          email?: string
          name?: string
          birth_year?: number | null
          gender?: string | null
          phone?: string | null
          emergency_contact?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      // ... other tables
    }
  }
}
```

## ğŸ—ƒï¸ Database Schema

### Core Tables
```sql
-- ğŸ‘¤ Users table
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  birth_year INTEGER,
  gender TEXT,
  phone TEXT,
  emergency_contact TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ğŸ“Š Health records table
CREATE TABLE health_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  record_type TEXT NOT NULL CHECK (record_type IN ('blood_pressure', 'blood_sugar', 'weight', 'heart_rate', 'temperature')),
  systolic_pressure INTEGER,
  diastolic_pressure INTEGER,
  heart_rate INTEGER,
  blood_sugar INTEGER,
  blood_sugar_type TEXT CHECK (blood_sugar_type IN ('fasting', 'post_meal')),
  weight DECIMAL(5,2),
  measurement_time TIMESTAMP WITH TIME ZONE NOT NULL,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ğŸ¯ Health goals table
CREATE TABLE health_goals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  goal_type TEXT NOT NULL,
  target_value DECIMAL(10,2),
  target_range_min DECIMAL(10,2),
  target_range_max DECIMAL(10,2),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ğŸ’Š Medications table
CREATE TABLE medications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  medication_name TEXT NOT NULL,
  dosage TEXT,
  frequency TEXT,
  start_date DATE,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## ğŸ” Row Level Security (RLS)

### RLS Policies
```sql
-- âœ… Enable RLS on all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE health_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE health_goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE medications ENABLE ROW LEVEL SECURITY;

-- ğŸ‘¤ Users can only access their own data
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid() = id);

-- ğŸ“Š Health records policies
CREATE POLICY "Users can view own health records" ON health_records
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own health records" ON health_records
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own health records" ON health_records
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own health records" ON health_records
  FOR DELETE USING (auth.uid() = user_id);
```

## ğŸ“Š Query Patterns

### Data Fetching
```typescript
// âœ… Standard data fetching pattern
export const fetchHealthRecords = async (userId: string) => {
  const { data, error } = await supabase
    .from('health_records')
    .select('*')
    .eq('user_id', userId)
    .order('measurement_time', { ascending: false })
  
  if (error) {
    console.error('ê±´ê°• ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
  
  return data
}
```

### Data Insertion
```typescript
// âœ… Data insertion with validation
export const addHealthRecord = async (record: Omit<HealthRecord, 'id' | 'created_at'>) => {
  const { data, error } = await supabase
    .from('health_records')
    .insert([record])
    .select()
    .single()
  
  if (error) {
    console.error('ê±´ê°• ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
  
  return data
}
```

### Data Updates
```typescript
// âœ… Data update pattern
export const updateHealthRecord = async (id: string, updates: Partial<HealthRecord>) => {
  const { data, error } = await supabase
    .from('health_records')
    .update(updates)
    .eq('id', id)
    .select()
    .single()
  
  if (error) {
    console.error('ê±´ê°• ê¸°ë¡ ìˆ˜ì • ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
  
  return data
}
```

### Data Deletion
```typescript
// âœ… Data deletion pattern
export const deleteHealthRecord = async (id: string) => {
  const { error } = await supabase
    .from('health_records')
    .delete()
    .eq('id', id)
  
  if (error) {
    console.error('ê±´ê°• ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
}
```

## ğŸ” Authentication

### OAuth Configuration
```typescript
// âœ… Google OAuth setup
export const signInWithGoogle = async () => {
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
      queryParams: {
        access_type: 'offline',
        prompt: 'consent',
      },
    },
  })
  
  if (error) {
    console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
  
  return data
}
```

### Session Management
```typescript
// âœ… Session handling
export const getCurrentSession = async () => {
  const { data: { session }, error } = await supabase.auth.getSession()
  
  if (error) {
    console.error('ì„¸ì…˜ ì¡°íšŒ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
  
  return session
}

export const signOut = async () => {
  const { error } = await supabase.auth.signOut()
  
  if (error) {
    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error)
    throw new Error(error.message)
  }
}
```

## ğŸ“ˆ Real-time Subscriptions

### Health Records Subscription
```typescript
// âœ… Real-time health records updates
export const subscribeToHealthRecords = (userId: string, callback: (payload: any) => void) => {
  const subscription = supabase
    .channel('health_records_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'health_records',
        filter: `user_id=eq.${userId}`,
      },
      callback
    )
    .subscribe()
  
  return subscription
}
```

## ğŸš¨ Error Handling

### Error Types
```typescript
// âœ… Define error types
interface SupabaseError {
  message: string
  details?: string
  hint?: string
  code?: string
}

const handleSupabaseError = (error: SupabaseError): string => {
  switch (error.code) {
    case 'PGRST116':
      return 'ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    case '23505':
      return 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ì…ë‹ˆë‹¤.'
    case '23503':
      return 'ê´€ë ¨ëœ ë°ì´í„°ê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    default:
      return error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
  }
}
```

### Retry Logic
```typescript
// âœ… Implement retry logic for network errors
export const fetchWithRetry = async <T>(
  operation: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await operation()
    } catch (error) {
      if (i === maxRetries - 1) throw error
      
      // Wait before retry (exponential backoff)
      await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000))
    }
  }
  
  throw new Error('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.')
}
```

## ğŸ”§ Utility Functions

### Connection Testing
```typescript
// âœ… Test Supabase connection
export const testSupabaseConnection = async (): Promise<boolean> => {
  try {
    const { data, error } = await supabase
      .from('users')
      .select('count')
      .limit(1)
    
    if (error) {
      console.error('Supabase ì—°ê²° ì‹¤íŒ¨:', error)
      return false
    }
    
    console.log('âœ… Supabase ì—°ê²° ì„±ê³µ!')
    return true
  } catch (error) {
    console.error('Supabase ì—°ê²° ì˜¤ë¥˜:', error)
    return false
  }
}
```

### Environment Validation
```typescript
// âœ… Validate environment variables
export const validateEnvironment = () => {
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
  const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY
  
  const isValid = !!(supabaseUrl && supabaseKey)
  
  if (!isValid) {
    console.warn('âš ï¸ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
  }
  
  return {
    url: !!supabaseUrl,
    key: !!supabaseKey,
    allSet: isValid
  }
}
```

## ğŸ“Š Performance Optimization

### Query Optimization
```typescript
// âœ… Use specific column selection
const { data, error } = await supabase
  .from('health_records')
  .select('id, record_type, measurement_time, systolic_pressure, diastolic_pressure')
  .eq('user_id', userId)
  .order('measurement_time', { ascending: false })
  .limit(10)

// âœ… Use pagination for large datasets
const { data, error } = await supabase
  .from('health_records')
  .select('*')
  .eq('user_id', userId)
  .range(offset, offset + limit - 1)
  .order('measurement_time', { ascending: false })
```

### Caching Strategy
```typescript
// âœ… Implement simple caching
const cache = new Map<string, { data: any; timestamp: number }>()
const CACHE_DURATION = 5 * 60 * 1000 // 5 minutes

export const getCachedData = async <T>(
  key: string,
  fetcher: () => Promise<T>
): Promise<T> => {
  const cached = cache.get(key)
  
  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
    return cached.data
  }
  
  const data = await fetcher()
  cache.set(key, { data, timestamp: Date.now() })
  
  return data
}
```