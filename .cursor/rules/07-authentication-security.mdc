---
globs: src/hooks/useAuth.ts,src/store/slices/authSlice.ts,src/components/ProtectedRoute.tsx
description: Authentication and Security Guidelines
---

# ğŸ” Authentication & Security Guidelines

## ğŸ”‘ Authentication Flow

### Custom Hook Pattern
```typescript
// âœ… Standard authentication hook
export const useAuth = () => {
  const { user, profile, loading, error } = useSelector((state: RootState) => state.auth)
  
  useEffect(() => {
    // Session management
    // OAuth state change handling
  }, [])
  
  return { 
    user, 
    profile, 
    loading, 
    error, 
    isAuthenticated: !!user 
  }
}
```

### Session Management
```typescript
// âœ… Session handling with error recovery
useEffect(() => {
  const getSession = async () => {
    try {
      const { data: { session }, error } = await supabase.auth.getSession()
      
      if (error) {
        console.error('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error)
        dispatch(setUser(null))
        return
      }
      
      if (session?.user) {
        dispatch(setUser(session.user))
        dispatch(getUserProfile(session.user.id))
      } else {
        dispatch(setUser(null))
      }
    } catch (err) {
      console.error('ì„¸ì…˜ í™•ì¸ ì—ëŸ¬:', err)
      dispatch(setUser(null))
    }
  }

  getSession()
}, [dispatch])
```

## ğŸ›¡ï¸ Protected Routes

### Route Protection
```typescript
// âœ… Protected route component
<Route 
  path="/dashboard" 
  element={
    isAuthenticated ? <DashboardPage /> : <Navigate to="/login" replace />
  } 
/>

<Route 
  path="/record" 
  element={
    isAuthenticated ? <HealthRecordPage /> : <Navigate to="/login" replace />
  } 
/>

<Route 
  path="/profile" 
  element={
    isAuthenticated ? <ProfilePage /> : <Navigate to="/login" replace />
  } 
/>
```

### Loading States
```typescript
// âœ… Handle loading states in protected routes
const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { isAuthenticated, loading } = useAuth()
  
  if (loading) {
    return (
      <Box sx={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        minHeight: '100vh' 
      }}>
        <CircularProgress />
        <Typography sx={{ ml: 2 }}>ì¸ì¦ í™•ì¸ ì¤‘...</Typography>
      </Box>
    )
  }
  
  return isAuthenticated ? <>{children}</> : <Navigate to="/login" replace />
}
```

## ğŸ”„ OAuth Configuration

### Google OAuth
```typescript
// âœ… Google OAuth implementation
export const signInWithGoogle = createAsyncThunk(
  'auth/signInWithGoogle',
  async (_, { rejectWithValue }) => {
    try {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          },
        },
      })
      
      if (error) {
        console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error)
      return rejectWithValue('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

### Kakao OAuth
```typescript
// âœ… Kakao OAuth implementation
export const signInWithKakao = createAsyncThunk(
  'auth/signInWithKakao',
  async (_, { rejectWithValue }) => {
    try {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'kakao',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
        },
      })
      
      if (error) {
        console.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error)
      return rejectWithValue('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

### Email/Password Authentication
```typescript
// âœ… Email/password authentication
export const signUp = createAsyncThunk(
  'auth/signUp',
  async ({ email, password, name }: { email: string; password: string; name: string }, { rejectWithValue }) => {
    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            name,
          },
        },
      })
      
      if (error) {
        console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error)
      return rejectWithValue('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)

export const signIn = createAsyncThunk(
  'auth/signIn',
  async ({ email, password }: { email: string; password: string }, { rejectWithValue }) => {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })
      
      if (error) {
        console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error)
      return rejectWithValue('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

## ğŸ”„ OAuth Callback Handling

### Callback Component
```typescript
// âœ… OAuth callback handler
const OAuthCallback: React.FC = () => {
  const dispatch = useDispatch<AppDispatch>()
  const navigate = useNavigate()
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading')
  
  useEffect(() => {
    const handleAuthCallback = async () => {
      try {
        // Check for tokens in URL hash
        const hash = window.location.hash
        const search = window.location.search
        
        if (hash.includes('access_token') || search.includes('code')) {
          // Let Supabase handle the session
          const { data: { session }, error } = await supabase.auth.getSession()
          
          if (error) {
            console.error('OAuth ì½œë°± ì²˜ë¦¬ ì‹¤íŒ¨:', error)
            setStatus('error')
            setTimeout(() => navigate('/login'), 2000)
            return
          }
          
          if (session?.user) {
            dispatch(setUser(session.user))
            dispatch(getUserProfile(session.user.id))
            setStatus('success')
            setTimeout(() => navigate('/dashboard'), 1000)
          } else {
            setStatus('error')
            setTimeout(() => navigate('/login'), 2000)
          }
        } else {
          setStatus('error')
          setTimeout(() => navigate('/login'), 2000)
        }
      } catch (error) {
        console.error('OAuth ì½œë°± ì˜¤ë¥˜:', error)
        setStatus('error')
        setTimeout(() => navigate('/login'), 2000)
      }
    }
    
    handleAuthCallback()
  }, [dispatch, navigate])
  
  return (
    <Box sx={{ 
      display: 'flex', 
      flexDirection: 'column',
      justifyContent: 'center', 
      alignItems: 'center', 
      minHeight: '100vh' 
    }}>
      {status === 'loading' && (
        <>
          <CircularProgress size={60} />
          <Typography sx={{ mt: 2 }}>ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</Typography>
        </>
      )}
      {status === 'success' && (
        <>
          <CheckCircleIcon sx={{ fontSize: 60, color: 'success.main' }} />
          <Typography sx={{ mt: 2 }}>ë¡œê·¸ì¸ ì„±ê³µ! ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤...</Typography>
        </>
      )}
      {status === 'error' && (
        <>
          <ErrorIcon sx={{ fontSize: 60, color: 'error.main' }} />
          <Typography sx={{ mt: 2 }}>ë¡œê·¸ì¸ ì‹¤íŒ¨. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</Typography>
        </>
      )}
    </Box>
  )
}
```

## ğŸš¨ Error Handling

### Authentication Errors
```typescript
// âœ… Authentication error handling
const AUTH_ERROR_MESSAGES = {
  'Invalid login credentials': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
  'Email not confirmed': 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.',
  'User already registered': 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
  'Password should be at least 6 characters': 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.',
  'Invalid email': 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.',
  'Signup is disabled': 'íšŒì›ê°€ì…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
  'Email rate limit exceeded': 'ì´ë©”ì¼ ì „ì†¡ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
  'Invalid OAuth provider': 'ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¡œê·¸ì¸ ë°©ì‹ì…ë‹ˆë‹¤.',
  'OAuth account not linked': 'OAuth ê³„ì •ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
} as const

const getAuthErrorMessage = (error: string): string => {
  return AUTH_ERROR_MESSAGES[error as keyof typeof AUTH_ERROR_MESSAGES] || error
}
```

### Error Recovery
```typescript
// âœ… Error recovery patterns
const handleAuthError = (error: string, dispatch: AppDispatch) => {
  const message = getAuthErrorMessage(error)
  
  // Clear any existing errors
  dispatch(clearError())
  
  // Set new error
  dispatch(setError(message))
  
  // Auto-clear error after 5 seconds
  setTimeout(() => {
    dispatch(clearError())
  }, 5000)
}
```

## ğŸ”’ Security Best Practices

### Input Validation
```typescript
// âœ… Input validation for authentication
const validateEmail = (email: string): boolean => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}

const validatePassword = (password: string): { isValid: boolean; message: string } => {
  if (password.length < 6) {
    return { isValid: false, message: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }
  }
  
  if (password.length > 128) {
    return { isValid: false, message: 'ë¹„ë°€ë²ˆí˜¸ëŠ” 128ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.' }
  }
  
  return { isValid: true, message: '' }
}

const validateName = (name: string): { isValid: boolean; message: string } => {
  if (name.length < 2) {
    return { isValid: false, message: 'ì´ë¦„ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }
  }
  
  if (name.length > 50) {
    return { isValid: false, message: 'ì´ë¦„ì€ 50ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.' }
  }
  
  return { isValid: true, message: '' }
}
```

### Session Security
```typescript
// âœ… Session security measures
const handleAuthStateChange = (event: string, session: Session | null) => {
  console.log('ì¸ì¦ ìƒíƒœ ë³€í™”:', event, session)
  
  switch (event) {
    case 'SIGNED_IN':
      if (session?.user) {
        dispatch(setUser(session.user))
        dispatch(getUserProfile(session.user.id))
      }
      break
      
    case 'SIGNED_OUT':
      dispatch(setUser(null))
      dispatch(clearProfile())
      break
      
    case 'TOKEN_REFRESHED':
      if (session?.user) {
        dispatch(setUser(session.user))
      }
      break
      
    case 'USER_UPDATED':
      if (session?.user) {
        dispatch(setUser(session.user))
        dispatch(getUserProfile(session.user.id))
      }
      break
  }
}
```

### Logout Security
```typescript
// âœ… Secure logout implementation
export const signOut = createAsyncThunk(
  'auth/signOut',
  async (_, { rejectWithValue }) => {
    try {
      const { error } = await supabase.auth.signOut()
      
      if (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      // Clear local state
      return null
    } catch (error) {
      console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error)
      return rejectWithValue('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

## ğŸ”„ Profile Management

### User Profile Updates
```typescript
// âœ… User profile management
export const updateUserProfile = createAsyncThunk(
  'auth/updateUserProfile',
  async (profileData: Partial<UserProfile>, { rejectWithValue, getState }) => {
    try {
      const state = getState() as RootState
      const userId = state.auth.user?.id
      
      if (!userId) {
        return rejectWithValue('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
      }
      
      const { data, error } = await supabase
        .from('users')
        .update(profileData)
        .eq('id', userId)
        .select()
        .single()
      
      if (error) {
        console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error)
      return rejectWithValue('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

### Profile Data Fetching
```typescript
// âœ… Fetch user profile data
export const getUserProfile = createAsyncThunk(
  'auth/getUserProfile',
  async (userId: string, { rejectWithValue }) => {
    try {
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('id', userId)
        .single()
      
      if (error) {
        console.error('í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', error)
        return rejectWithValue(error.message)
      }
      
      return data
    } catch (error) {
      console.error('í”„ë¡œí•„ ì¡°íšŒ ì˜¤ë¥˜:', error)
      return rejectWithValue('í”„ë¡œí•„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    }
  }
)
```

## ğŸ§ª Testing Authentication

### Mock Authentication
```typescript
// âœ… Mock authentication for testing
export const createMockAuthState = (overrides: Partial<AuthState> = {}): AuthState => ({
  user: null,
  profile: null,
  loading: false,
  error: null,
  ...overrides
})

export const createMockUser = (overrides: Partial<User> = {}): User => ({
  id: 'test-user-id',
  email: 'test@example.com',
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  ...overrides
} as User)
```

### Authentication Test Utilities
```typescript
// âœ… Authentication test utilities
export const renderWithAuth = (component: React.ReactElement, authState: AuthState) => {
  const store = createMockStore({ auth: authState })
  
  return render(
    <Provider store={store}>
      <Router>
        {component}
      </Router>
    </Provider>
  )
}
```